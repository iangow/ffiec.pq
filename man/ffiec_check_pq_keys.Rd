% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/ffiec_manifest.R
\name{ffiec_check_pq_keys}
\alias{ffiec_check_pq_keys}
\title{Check primary-key and non-NULL constraints in FFIEC Parquet files}
\usage{
ffiec_check_pq_keys(
  conn,
  schedule = NULL,
  cols,
  data_dir = NULL,
  schema = "ffiec",
  prefix = ""
)
}
\arguments{
\item{conn}{A valid DuckDB connection.}

\item{schedule}{Optional character scalar giving the FFIEC schedule
to check (e.g. \code{"rc"}, \code{"rci"}). Passed to
[ffiec_scan_pqs()].}

\item{cols}{Character vector of column names that together define
the primary key and must also be non-missing.}

\item{data_dir}{Optional parent directory containing FFIEC Parquet
files. If \code{NULL}, the directory is resolved using the
\code{DATA_DIR} environment variable.}

\item{schema}{Schema name used to resolve the Parquet directory
(default \code{"ffiec"}). Set to \code{NULL} to treat \code{data_dir}
as the final directory.}

\item{prefix}{Optional filename prefix used when the Parquet files
were created (default \code{""}).}
}
\value{
A tibble with one row per checked schedule and columns:
\describe{
  \item{schedule}{FFIEC schedule identifier.}
  \item{ok}{Logical; \code{TRUE} if no violations were detected.}
  \item{null_violations}{A tibble listing columns and counts of
    missing values, or empty if none were found.}
  \item{pk_violations}{A tibble of duplicated key combinations,
    or empty if the key is unique.}
}
}
\description{
Scans FFIEC Parquet files into DuckDB and verifies that a specified
set of columns jointly satisfies two integrity constraints:
}
\details{
\itemize{
  \item No missing values (non-NULL constraint)
  \item Uniqueness across rows (primary-key constraint)
}

The function operates lazily via DuckDB and only materializes rows
involved in violations. It is intended as a lightweight validation
tool for Parquet files produced by [ffiec_process()].
}
\examples{
\dontrun{
library(duckdb)
con <- DBI::dbConnect(duckdb::duckdb())

# Check IDRSSD-date uniqueness for the RC schedule
ffiec_check_pq_keys(
  conn = con,
  schedule = "rc",
  cols = c("IDRSSD", "date")
)

# Check all schedules
schedules <- ffiec_list_pqs() |> dplyr::distinct(schedule) |> dplyr::pull()
results <- purrr::map_dfr(
  schedules,
  \(s) ffiec_check_pq_keys(con, s, c("IDRSSD", "date"))
)
}

}
